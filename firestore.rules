rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helpers

    // Allow access only to authenticated users
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check whether the current user is the resource owner
    function isOwner(ownerId) {
      return request.auth.uid == ownerId;
    }

    // Fetch a project document by projectId
    function getProject(projectId) {
      return get(/databases/$(database)/documents/projects/$(projectId));
    }

    // Get ownerId from the parent project
    function projectOwner(projectId) {
      return getProject(projectId).data.ownerId;
    }

    // Ensure only allowed fields are written to the document
    function onlyKeys(allowedKeys) {
      return request.resource.data.keys().hasOnly(allowedKeys);
    }

    // Projects
    match /projects/{projectId} {

      // Check if the authenticated user owns this project
      function isProjectOwner() {
        return isOwner(resource.data.ownerId);
      }

      // Project can be read or deleted only by its owner
      allow read, delete: if isAuthenticated() && isProjectOwner();

      // Create project: authenticated user must be the owner
      allow create: if isAuthenticated()
        && isOwner(request.resource.data.ownerId)
        && onlyKeys([
      'ownerId',
      'title',
      'description',
      'createdAt',
      'updatedAt'
      ])
        && request.resource.data.title is string
        && request.resource.data.title.size() > 0;

      // Update project: only owner, immutable ownerId & createdAt
      allow update: if isAuthenticated()
        && isProjectOwner()
        && request.resource.data.ownerId == resource.data.ownerId
        && onlyKeys([
      'ownerId',
      'title',
      'description',
      'createdAt',
      'updatedAt'
      ])
        && request.resource.data.createdAt == resource.data.createdAt
        && request.resource.data.title is string
        && request.resource.data.title.size() > 0;

      // Tasks subcollection
      match /tasks/{taskId} {

        // Task access is granted only if user owns the parent project
        function isTaskOwner() {
          return isOwner(projectOwner(projectId));
        }

        // Read or delete task: project owner only
        allow read, delete: if isAuthenticated() && isTaskOwner();

        // Create task under owned project
        allow create: if isAuthenticated()
          && isTaskOwner()
          && onlyKeys([
        'title',
        'status',
        'dueDate',
        'createdAt',
        'updatedAt'
        ])
          && request.resource.data.title is string
          && request.resource.data.title.size() > 0
          && request.resource.data.status in ['open', 'done'];

        // Update task: immutable createdAt, valid status
        allow update: if isAuthenticated()
          && isTaskOwner()
          && onlyKeys([
        'title',
        'status',
        'dueDate',
        'createdAt',
        'updatedAt'
        ])
          && request.resource.data.createdAt == resource.data.createdAt
          && request.resource.data.title is string
          && request.resource.data.title.size() > 0
          && request.resource.data.status in ['open', 'done'];
      }
    }
  }
}
